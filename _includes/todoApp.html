<html>
    <body>
        <div id="todoApp">
            <h2>Personal To Do List</h2>
                <div class="input-container">
                    <input type="text" id="todoInput" placeholder="Enter a new task...">
                    <button id="addTodo">Add Task</button>
                </div>
            <ul id="todoList"></ul>
        </div>
    </body>
</html>

<script type="module" src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/9.21.0/firebase-analytics.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js"></script>

<script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-analytics.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, getDocs, addDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";

// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
    apiKey: "AIzaSyAgjTZHgeW_Mj9ob8_3OYFGx_xgBoa0yH0",
    authDomain: "meongju0o0-git-blog-todolist.firebaseapp.com",
    projectId: "meongju0o0-git-blog-todolist",
    storageBucket: "meongju0o0-git-blog-todolist.appspot.com",
    messagingSenderId: "462108512601",
    appId: "1:462108512601:web:9d5a3357bbae002828fc48",
    measurementId: "G-RHKPH551R7"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let ref = collection(db, 'tasks')
let dragSrcEl = null;

function createListItem(taskId, task, state) {
  const listItem = document.createElement('li');
  listItem.setAttribute('data-task-id', taskId);
  listItem.setAttribute('draggable', 'true');
  listItem.addEventListener('dragstart', dragStartHandler);
  listItem.addEventListener('dragover', dragOverHandler);
  listItem.addEventListener('drop', dropHandler);
  listItem.addEventListener('dragleave', dragLeaveHandler);
  listItem.addEventListener('dragend', dragEndHandler);

  const taskNumber = document.createElement('span');
  taskNumber.className = 'task-number';
  listItem.appendChild(taskNumber);

  const taskContent = document.createElement('span');
  taskContent.className = 'task-content';
  taskContent.textContent = task;
  listItem.appendChild(taskContent);

  const taskButtons = document.createElement('div');
  taskButtons.className = 'task-buttons';
  listItem.appendChild(taskButtons);

  const statusButton = createStatusButton(state);
  taskButtons.appendChild(statusButton);

  return listItem;
}

function dragStartHandler(e) {
  e.stopPropagation();
  dragSrcEl = this;
  dragSrcEl.style.opacity = '0.5';
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', '');
  e.dataTransfer.setData('text/html', this.innerHTML);
  e.dataTransfer.setData('index', Array.from(dragSrcEl.parentElement.children).indexOf(dragSrcEl));
}

function dragOverHandler(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  const target = e.target.closest('li');
  if (!target) {
    return;
  }
  const rect = target.getBoundingClientRect();
  const offsetY = e.clientY - rect.top;
  const direction = offsetY > rect.height / 2 ? 'bottom' : 'top';
  target.style.border = 'none';
  target.style.borderBottom = direction === 'bottom';
  target.style.borderTop = direction === 'top';
}

function dropHandler(e) {
  e.preventDefault();
  e.stopPropagation();
  const srcIndex = parseInt(e.dataTransfer.getData('index'));
  const target = e.target.closest('li');
  if (!target) {
    return;
  }
  const dstIndex = Array.from(target.parentElement.children).indexOf(target);
  const parentNode = target.parentNode;
  const srcItem = parentNode.children[srcIndex];
  const dstItem = parentNode.children[dstIndex];
  const direction = target.style.borderTop ? 'before' : 'after';
  if (direction === 'before') {
    parentNode.insertBefore(srcItem, dstItem);
  } else {
    parentNode.insertBefore(srcItem, dstItem.nextSibling);
  }
  target.style.border = 'none';
  dragSrcEl.style.opacity = '1';
  updateTaskNumbers();
}

function dragLeaveHandler(e) {
  e.preventDefault();
  e.stopPropagation();
  const target = e.target.closest('li');
  if (!target) {
    return;
  }
  target.style.border = 'none';
}

function dragEndHandler(e) {
  e.stopPropagation();
}

async function statusButtonClick(e) {
  const buttonStates = ['Not Yet', 'Started', 'Done', 'Delete', '_'];
  let currentState = buttonStates.indexOf(e.target.innerText);
  currentState = (currentState + 1) % buttonStates.length;
  e.target.innerText = buttonStates[currentState];
  const item = e.target.closest('li');
  if (e.target.innerText === '_') {
    await deleteDoc(doc(db, 'tasks', item.getAttribute('data-task-id')));
    item.remove();
    updateTaskNumbers();
  }
  else {
    await updateDoc(doc(db, 'tasks', item.getAttribute('data-task-id')), {
        state: e.target.innerText
    });
  }
}


async function updateTaskNumbers() {
  const listItems = document.querySelectorAll('#todoList li');
  listItems.forEach((item, index) => {
    const taskNumber = item.querySelector('.task-number');
    taskNumber.innerHTML = (index + 1).toString() + ".&nbsp;";
  });
  listItems.forEach(async (item, index) => {
    await updateDoc(doc(db, 'tasks', item.getAttribute('data-task-id')), {
        order: index
    });
  });
}

function createStatusButton(initialState) {
  const statusButton = document.createElement('button');
  const buttonStates = ['Not Yet', 'Started', 'Done', 'Delete', '_'];
  let currentState = buttonStates.indexOf(initialState);
  statusButton.innerText = buttonStates[currentState];
  statusButton.addEventListener('click', statusButtonClick);
  return statusButton;
}

async function addNewTask(task) {
  const docRef = await addDoc(ref, {
    task: task,
    state: 'Not Yet',
    order: -1,
    createdAt: new Date().toISOString()
  });
  const taskId = docRef.id;
  const listItem = createListItem(taskId, task, 'Not Yet');
  updateTaskNumbers();
}

async function addTask() {
  var task = document.getElementById('todoInput').value;
  if (task.trim() !== "") {
    await addNewTask(task);
    document.getElementById('todoInput').value = "";
    loadTasksFromFirestore();
  }
}

document.getElementById('todoInput').addEventListener('keypress', function (event) {
  if (event.key === 'Enter') {
    addTask();
  }
});

document.getElementById('addTodo').addEventListener('click', function () {
  addTask();
});

async function loadTasksFromFirestore() {
  const tasksQuery = query(collection(db, 'tasks'), orderBy('order'));
  const querySnapshot = await getDocs(tasksQuery);

  querySnapshot.forEach((doc) => {
    const data = doc.data();
    const taskId = doc.id;
    const listItem = createListItem(taskId, data.task, data.state);
    document.getElementById('todoList').appendChild(listItem);
  });

  updateTaskNumbers();
}

loadTasksFromFirestore();
</script>